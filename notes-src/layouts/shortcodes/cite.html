{{- /*
Usage:
  {{< cite id="wang2024" text="Wang et al., 2024" >}}
  or positional: {{< cite "wang2024" "Wang et al., 2024" >}}

Effect:
  - Renders an in-text citation link to the References section.
  - Collects the citation id in .Page.Scratch "cites" for later rendering.
*/ -}}
{{- $id := or (.Get "id") (.Get 0) -}}
{{- $text := or (.Get "text") (.Get 1) -}}
{{- if not $id -}}
  {{- errorf "cite shortcode requires an 'id' (or first positional)" -}}
{{- end -}}
{{- if not $text -}}
  {{- $text = $id -}}
{{- end -}}

{{- /* Track unique citation order per page */ -}}
{{- $existing := .Page.Scratch.Get "cites" -}}
{{- $existingStr := printf "%v" (default "" $existing) -}}
{{- $seen := false -}}
{{- range (split $existingStr ",") -}}
  {{- if eq . $id }}{{ $seen = true }}{{ end -}}
{{- end -}}
{{- if not $seen -}}
  {{- if $existingStr -}}
    {{- .Page.Scratch.Set "cites" (print $existingStr "," $id) -}}
  {{- else -}}
    {{- .Page.Scratch.Set "cites" $id -}}
  {{- end -}}
{{- end -}}

{{- /* Build automatic text if not provided, using authors/year if available */ -}}
{{- if not $text -}}
  {{- $refsPage := .Page.Params.references | default dict -}}
  {{- $refsSite := (index .Site.Data "references") | default dict -}}
  {{- $entry := or (index $refsPage $id) (index $refsSite $id) -}}
  {{- if $entry -}}
    {{- $authors := (index $entry "authors") | default (index $entry "author") | default "" -}}
    {{- $std := replaceRE `\s+and\s+` ";" $authors -}}
    {{- $partsRaw := split $std ";" -}}
    {{- $.Scratch.Set "names" (slice) -}}
    {{- range $partsRaw -}}
      {{- $t := . | strings.Trim " " -}}
      {{- if $t -}}
        {{- if in $t "," -}}
          {{- $.Scratch.Add "names" (slice (index (split $t ",") 0 | strings.Trim " ")) -}}
        {{- else -}}
          {{- $w := split $t " " -}}
          {{- $.Scratch.Add "names" (slice (index $w (sub (len $w) 1))) -}}
        {{- end -}}
      {{- end -}}
    {{- end -}}
    {{- $names := $.Scratch.Get "names" | default (slice) -}}
    {{- $n := len $names -}}
    {{- $label := $id -}}
    {{- if eq $n 1 -}}
      {{- $label = index $names 0 -}}
    {{- else if eq $n 2 -}}
      {{- $label = printf "%s and %s" (index $names 0) (index $names 1) -}}
    {{- else if gt $n 2 -}}
      {{- $label = printf "%s et al." (index $names 0) -}}
    {{- end -}}
    {{- $year := printf "%v" ((index $entry "year") | default "") -}}
    {{- if $year -}}
      {{- $text = printf "%s, %s" $label $year -}}
    {{- else -}}
      {{- $text = $label -}}
    {{- end -}}
  {{- end -}}
{{- end -}}

{{- /* Use a URL-safe key for anchor ids */ -}}
{{- $key := $id | urlize -}}
<a class="citation" href="#ref-{{ $key }}" id="cite-{{ $key }}" data-cite-id="{{ $id }}">{{ $text }}</a>
