{{- /*
Auto-append References section after page content if citations were used.
Looks up full entries from .Params.references keyed by citation id.
Each entry may be a string or a map with fields: text (required), url (optional).
*/ -}}
{{- $cites := .Page.Scratch.Get "cites" | default (slice) -}}
{{- if gt (len $cites) 0 -}}
  <hr>
  <h2 id="references">References</h2>
  <ol class="references-list">
  {{- $refsPage := .Params.references | default dict -}}
  {{- $refsSite := (index .Site.Data "references") | default dict -}}
  {{- range $cites -}}
    {{- $id := . -}}
    {{- $key := $id | urlize -}}
    {{- $entry := or (index $refsPage $id) (index $refsSite $id) -}}
    {{- $type := printf "%T" $entry -}}
    {{- $authors := "" -}}
    {{- $title := "" -}}
    {{- $venue := "" -}}{{- $year := "" -}}{{- $url := "" -}}{{- $doi := "" -}}{{- $arxiv := "" -}}
    {{- if eq $type "map[string]interface {}" -}}
      {{- $authors = (index $entry "authors") | default (index $entry "author") | default "" -}}
      {{- $title = (index $entry "title") | default "" -}}
      {{- $venue = (index $entry "venue") | default (index $entry "journal") | default (index $entry "conference") | default (index $entry "booktitle") | default "" -}}
      {{- $year = (printf "%v" ((index $entry "year") | default "")) -}}
      {{- $url = (index $entry "url") | default "" -}}
      {{- $doi = (index $entry "doi") | default "" -}}
      {{- $arxiv = (index $entry "arxiv") | default "" -}}
    {{- end -}}
    {{- /* Fallback to 'text' if provided */ -}}
    {{- $text := (index $entry "text") -}}
    <li id="ref-{{ $key }}">
      {{- if $text -}}
        {{- if $url -}}<a href="{{ $url }}" target="_blank" rel="noopener">{{ $text }}</a>{{- else -}}{{ $text }}{{- end -}}
      {{- else -}}
        {{- if $authors -}}<span class="ref-authors">{{ $authors }}</span>. {{- end -}}
        {{- if $url -}}<a href="{{ $url }}" target="_blank" rel="noopener"><span class="ref-title">{{ $title }}</span></a>{{- else -}}<span class="ref-title">{{ $title }}</span>{{- end -}}.
        {{- if $venue }} <span class="ref-venue">{{ $venue }}</span>{{- end -}}{{- if $year }}, <span class="ref-year">{{ $year }}</span>{{- end -}}.
        {{- if and (not $url) $doi }} <a href="https://doi.org/{{ $doi }}" target="_blank" rel="noopener">doi:{{ $doi }}</a>.{{- end -}}
        {{- if and (not $url) $arxiv }} <a href="https://arxiv.org/abs/{{ $arxiv }}" target="_blank" rel="noopener">arXiv:{{ $arxiv }}</a>.{{- end -}}
      {{- end -}}
      <a class="ref-backlink" href="#cite-{{ $key }}" aria-label="Back to citation">â†‘</a>
    </li>
  {{- end -}}
  </ol>
{{- end -}}
